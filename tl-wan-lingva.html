<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TranscripciÃ³n y TraducciÃ³n con LibreTranslate</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .contenedor {
      display: flex;
      gap: 1em;
      flex-grow: 1;
      padding: 1em;
    }

    textarea {
      width: 100%;
      height: 100%;
      font-size: 1.1em;
      overflow-y: auto;
      resize: none;
    }

    button, select {
      padding: 10px 20px;
      font-size: 1em;
    }

    .botones {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .botones-container {
      padding: 1em;
    }

    #estadoTraduccion {
      margin-bottom: 0.5em;
      font-style: italic;
      color: gray;
    }

    .columna {
      width: 50%;
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body>

  <h2>ğŸŒ TranscripciÃ³n, TraducciÃ³n y Voz - lingva - wan</h2>

  <div class="botones-container">
    <label for="idiomaOrigen">Idioma de entrada:</label>
    <select id="idiomaOrigen">
      <option value="es">EspaÃ±ol</option>
      <option value="en">InglÃ©s</option>
      <option value="zh">Chino</option>
    </select>

    <label for="idiomaDestino">Idioma de destino:</label>
    <select id="idiomaDestino">
      <option value="en">InglÃ©s</option>
      <option value="es">EspaÃ±ol</option>
      <option value="zh">Chino</option>
    </select>

    <label for="alternativas">Alternativas de transcripciÃ³n:</label>
    <select id="alternativas">
      <option value="1">1 Alternativa</option>
      <option value="2">2 Alternativas</option>
      <option value="3">3 Alternativas</option>
      <option value="4">4 Alternativas</option>
    </select>

    <div class="botones">
      <button id="botonTranscribir">ğŸ”´ Iniciar</button>
      <button id="botonBorrar">ğŸ—‘ï¸ Borrar</button>
      <button id="toggleTextBox">ğŸ“ Ocultar texto original</button>
      <button id="toggleVoz">ğŸ”Š Reproduciendo texto</button>
      <button id="botonProbarVoz">ğŸ”‰ Probar voz</button>
    </div>
  </div>

  <div class="contenedor">
    <textarea id="textoOriginal" placeholder="Texto original (voz)" readonly></textarea>

    <div class="columna">
      <div id="estadoTraduccion">Estado: Parado</div>
      <textarea id="textoTraducido" placeholder="TraducciÃ³n" readonly></textarea>
    </div>
  </div>

  <script>
    const botonTranscribir = document.getElementById('botonTranscribir');
    const botonBorrar = document.getElementById('botonBorrar');
    const botonProbarVoz = document.getElementById('botonProbarVoz');
    const textoOriginal = document.getElementById('textoOriginal');
    const textoTraducido = document.getElementById('textoTraducido');
    const idiomaOrigen = document.getElementById('idiomaOrigen');
    const idiomaDestino = document.getElementById('idiomaDestino');
    const toggleTextBox = document.getElementById('toggleTextBox');
    const toggleVoz = document.getElementById('toggleVoz');
    const alternativasSelect = document.getElementById('alternativas');
    const estadoTraduccion = document.getElementById('estadoTraduccion');

    let isSpeaking = true;
    let alternativas = 1;
    let escuchando = false;
    let textoAcumulado = "";

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.lang = "es-ES";
    recognition.maxAlternatives = alternativas;

    toggleTextBox.addEventListener('click', () => {
      if (textoOriginal.style.display === 'none') {
        textoOriginal.style.display = 'block';
        toggleTextBox.textContent = 'ğŸ“ Ocultar texto original';
      } else {
        textoOriginal.style.display = 'none';
        toggleTextBox.textContent = 'ğŸ“ Mostrar texto original';
      }
    });

    toggleVoz.addEventListener('click', () => {
      isSpeaking = !isSpeaking;
      toggleVoz.textContent = isSpeaking ? 'ğŸ”Š Reproduciendo texto' : 'ğŸ”‡ Silenciando texto';
    });

    alternativasSelect.addEventListener('change', (event) => {
      alternativas = parseInt(event.target.value);
      recognition.maxAlternatives = alternativas;
    });

    function reiniciarReconocimiento() {
      setTimeout(() => {
        try {
          recognition.start();
          console.log("ğŸ”„ Reconocimiento reiniciado");
        } catch (e) {
          console.warn("âš ï¸ Error al reiniciar:", e.message);
        }
      }, 100);
    }

    recognition.onresult = (event) => {
      let textoFinal = '';
      for (let i = event.resultIndex; i < event.results.length; ++i) {
        const resultado = event.results[i];
        if (resultado.isFinal) {
          textoFinal = resultado[0].transcript.trim();
          if (textoFinal && textoFinal !== textoAcumulado) {
            textoAcumulado = textoFinal;
            textoOriginal.value += textoFinal + '\n';
            autoScroll(textoOriginal);
            traducirLibreTranslate(textoFinal);
          }
        }
      }
    };

    recognition.onend = () => {
      if (escuchando) reiniciarReconocimiento();
    };

    recognition.onerror = (event) => {
      console.error("â— Error en reconocimiento:", event.error);
      if (escuchando) reiniciarReconocimiento();
    };

    botonTranscribir.addEventListener('click', () => {
      if (!escuchando) {
        try {
          recognition.lang = idiomaOrigen.value;
          recognition.start();
          escuchando = true;
          botonTranscribir.textContent = 'ğŸŸ¢ Detener';
          estadoTraduccion.textContent = "Estado: Esperando...";
        } catch (e) {
          console.error("âŒ No se pudo iniciar:", e.message);
        }
      } else {
        recognition.stop();
        escuchando = false;
        botonTranscribir.textContent = 'ğŸ”´ Iniciar';
        estadoTraduccion.textContent = "Estado: Parado";
      }
    });

    botonBorrar.addEventListener('click', () => {
      textoOriginal.value = '';
      textoTraducido.value = '';
      textoAcumulado = '';
    });

    botonProbarVoz.addEventListener('click', () => {
      hablar("This is a test voice. Hello!", idiomaDestino.value);
    });

    async function traducirLibreTranslate(texto) {

      const destino = idiomaDestino.value;
      estadoTraduccion.textContent = "Estado: Traduciendo...";

      try {
        const res = await fetch(`https://lingva.ml/api/v1/${idiomaOrigen.value}/${idiomaDestino.value}/${encodeURIComponent(texto)}`);
        const data = await res.json();

        const traduccion = data.translation;

        textoTraducido.value += traduccion + '\n';
        autoScroll(textoTraducido);
        if (isSpeaking) hablar(traduccion, destino);
      } catch (err) {
        textoTraducido.value += '[Error de traducciÃ³n]\n';
        console.error("âŒ Error al traducir:", err.message);
      } finally {
        estadoTraduccion.textContent = escuchando ? "Estado: Esperando..." : "Estado: Parado";
      }
    }

    function hablar(texto, idioma = 'en') {
      const utterance = new SpeechSynthesisUtterance(texto);
      utterance.lang = idioma;

      const voces = speechSynthesis.getVoices();
      const voz = voces.find(v => v.lang.startsWith(idioma));
      if (voz) utterance.voice = voz;

      speechSynthesis.speak(utterance);
    }

    window.speechSynthesis.onvoiceschanged = () => {
      speechSynthesis.getVoices();
    };

    function autoScroll(textarea) {
      textarea.scrollTop = textarea.scrollHeight;
    }
  </script>

</body>
</html>

