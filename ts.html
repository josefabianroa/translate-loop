<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Transcripci√≥n y Traducci√≥n con LibreTranslate - robin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .contenedor {
      display: flex;
      gap: 1em;
      flex-grow: 1;
      padding: 1em;
    }

    textarea {
      width: 100%;
      height: 100%;
      font-size: 1.1em;
      overflow-y: auto;
      resize: none;
    }

    button, select {
      padding: 10px 20px;
      font-size: 1em;
    }

    .botones {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .botones-container {
      padding: 1em;
    }

    #estadoTraduccion {
      margin-bottom: 0.5em;
      font-style: italic;
      color: gray;
    }

    .columna {
      width: 50%;
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body>

  <h2>üåê Transcripci√≥n, Traducci√≥n y Voz - robin</h2>

  <div class="botones-container">
    <label for="idiomaOrigen">Idioma de entrada:</label>
    <select id="idiomaOrigen">
      <option value="es">Espa√±ol</option>
      <option value="en">Ingl√©s</option>
      <option value="zh">Chino</option>
      <option value="de">Alem√°n</option>
    </select>

    <label for="idiomaDestino">Idioma de destino:</label>
    <select id="idiomaDestino">
      <option value="en">Ingl√©s</option>
      <option value="es">Espa√±ol</option>
      <option value="zh">Chino</option>
      <option value="de">Alem√°n</option>
    </select>

    <label for="alternativas">Alternativas de transcripci√≥n:</label>
    <select id="alternativas">
      <option value="1">1 Alternativa</option>
      <option value="2">2 Alternativas</option>
      <option value="3">3 Alternativas</option>
      <option value="4">4 Alternativas</option>
    </select>

    <div class="botones">
      <button id="botonTranscribir">üî¥ Iniciar</button>
      <button id="botonBorrar">üóëÔ∏è Borrar</button>
      <button id="toggleTextBox">üìù Ocultar texto original</button>
      <button id="toggleVoz">üîä Reproduciendo texto</button>
      <button id="botonProbarVoz">Probar voz</button>
      <button id="botonProbarRed">Probar red</button>
    </div>
  </div>

  <div class="contenedor">
    <textarea id="textoOriginal" placeholder="Texto original (voz)" readonly></textarea>

    <div class="columna">
      <div id="estadoTraduccion">Estado: Parado</div>
      <textarea id="textoTraducido" placeholder="Traducci√≥n" readonly></textarea>
    </div>
  </div>

  <script>
    const botonTranscribir = document.getElementById('botonTranscribir');
    const botonBorrar = document.getElementById('botonBorrar');
    const botonProbarVoz = document.getElementById('botonProbarVoz');
    const botonProbarRed = document.getElementById('botonProbarRed');
    const textoOriginal = document.getElementById('textoOriginal');
    const textoTraducido = document.getElementById('textoTraducido');
    const idiomaOrigen = document.getElementById('idiomaOrigen');
    const idiomaDestino = document.getElementById('idiomaDestino');
    const toggleTextBox = document.getElementById('toggleTextBox');
    const toggleVoz = document.getElementById('toggleVoz');
    const alternativasSelect = document.getElementById('alternativas');
    const estadoTraduccion = document.getElementById('estadoTraduccion');

    let isSpeaking = true;
    let alternativas = 1;
    let escuchando = false;
    let textoAcumulado = "";

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.lang = "es-ES";
    recognition.maxAlternatives = alternativas;

    toggleTextBox.addEventListener('click', () => {
      if (textoOriginal.style.display === 'none') {
        textoOriginal.style.display = 'block';
        toggleTextBox.textContent = 'üìù Ocultar texto original';
      } else {
        textoOriginal.style.display = 'none';
        toggleTextBox.textContent = 'üìù Mostrar texto original';
      }
    });

    toggleVoz.addEventListener('click', () => {
      isSpeaking = !isSpeaking;
      toggleVoz.textContent = isSpeaking ? 'üîä Reproduciendo texto' : 'üîá Silenciando texto';
    });

    alternativasSelect.addEventListener('change', (event) => {
      alternativas = parseInt(event.target.value);
      recognition.maxAlternatives = alternativas;
    });

    function reiniciarReconocimiento() {
      setTimeout(() => {
        try {
          recognition.start();
          console.log("üîÑ Reconocimiento reiniciado");
        } catch (e) {
          console.warn("‚ö†Ô∏è Error al reiniciar:", e.message);
        }
      }, 100);
    }

    recognition.onresult = (event) => {
      let textoFinal = '';
      for (let i = event.resultIndex; i < event.results.length; ++i) {
        const resultado = event.results[i];
        if (resultado.isFinal) {
          textoFinal = resultado[0].transcript.trim();
          if (textoFinal && textoFinal !== textoAcumulado) {
            textoAcumulado = textoFinal;
            textoOriginal.value += textoFinal + '\n';
            autoScroll(textoOriginal);
            traducirLibreTranslate(textoFinal);
          }
        }
      }
    };

    recognition.onend = () => {
      if (escuchando) reiniciarReconocimiento();
    };

    recognition.onerror = (event) => {
      console.error("‚ùó Error en reconocimiento:", event.error);
      if (escuchando) reiniciarReconocimiento();
    };

    botonTranscribir.addEventListener('click', () => {
      if (!escuchando) {
        try {
          recognition.lang = idiomaOrigen.value;
          recognition.start();
          escuchando = true;
          botonTranscribir.textContent = 'üü¢ Detener';
          estadoTraduccion.textContent = "Estado: Esperando...";
        } catch (e) {
          console.error("‚ùå No se pudo iniciar:", e.message);
        }
      } else {
        recognition.stop();
        escuchando = false;
        botonTranscribir.textContent = 'üî¥ Iniciar';
        estadoTraduccion.textContent = "Estado: Parado";
      }
    });

    botonBorrar.addEventListener('click', () => {
      textoOriginal.value = '';
      textoTraducido.value = '';
      textoAcumulado = '';
    });

    botonProbarVoz.addEventListener('click', () => {
      hablar("This is a test voice. Hello!", idiomaDestino.value);
    });

    botonProbarRed.addEventListener('click', () => {
      window.open('https://192.168.1.156:3013', '_blank');
    });

    async function traducirLibreTranslate(texto) {
      const origen = idiomaOrigen.value;
      const destino = idiomaDestino.value;
      const url = "https://192.168.1.156:3013/api/translate";

      estadoTraduccion.textContent = "Estado: Traduciendo...";

      try {
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            q: texto,
            source: origen,
            target: destino,
            format: "text"
          })
        });

        if (!res.ok) throw new Error("Respuesta no v√°lida del servidor");

        const data = await res.json();
        const traduccion = data.translatedText;

        textoTraducido.value += traduccion + '\n';
        autoScroll(textoTraducido);
        if (isSpeaking) hablar(traduccion, destino);
      } catch (err) {
        textoTraducido.value += '[Error de traducci√≥n]\n';
        console.error("‚ùå Error al traducir:", err.message);
      } finally {
        estadoTraduccion.textContent = escuchando ? "Estado: Esperando..." : "Estado: Parado";
      }
    }

    function hablar(texto, idioma = 'en') {
      const utterance = new SpeechSynthesisUtterance(texto);
      utterance.lang = idioma;

      const voces = speechSynthesis.getVoices();
      const voz = voces.find(v => v.lang.startsWith(idioma));
      if (voz) utterance.voice = voz;

      speechSynthesis.speak(utterance);
    }

    window.speechSynthesis.onvoiceschanged = () => {
      speechSynthesis.getVoices();
    };

    function autoScroll(textarea) {
      textarea.scrollTop = textarea.scrollHeight;
    }
  </script>

</body>
</html>

